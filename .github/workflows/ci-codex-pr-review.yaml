---
name: CI - Codex PR Review

on:
  # pull_request:
  #   types: [opened, edited, synchronize, reopened]
  #   branches:
  #     - dev
  workflow_dispatch:
  
permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

jobs:
  codex:
    if: ${{ github.actor != 'dependabot[bot]' }}
    runs-on: ubuntu-latest
    outputs:
      final_message: ${{ steps.run_codex.outputs.final-message }}
    steps:
      - uses: actions/checkout@v5
        with:
          # Explicitly check out the PR's merge commit.
          ref: refs/pull/${{ github.event.pull_request.number }}/merge

      - name: Pre-fetch base and head refs for the PR
        run: |
          git fetch --no-tags origin \
            ${{ github.event.pull_request.base.ref }} \
            +refs/pull/${{ github.event.pull_request.number }}/head

      - name: Run Codex
        id: run_codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ env.OPENAI_API_KEY }}
          sandbox: read-only
          prompt: |
            This is PR #${{ github.event.pull_request.number }} for ${{ github.repository }}.
            Base SHA: ${{ github.event.pull_request.base.sha }}
            Head SHA: ${{ github.event.pull_request.head.sha }}

            Review only the lines changed in this PR (the diff), ignore and do not reference any unchanged files or code. 
            Report only issues directly caused by the modified lines (bugs, security/privacy risks, performance pitfalls, logic/edge-case errors, API/contract breaks, missing tests or validation). 
            Keep feedback terse and actionable: for each point, name the changed file and line, give a one-sentence rationale, and a one-sentence fix.
            Do not invent files or symbols.
            If nothing actionable is found, reply with “No issues found.”

            Pull request title and body:
            ----
            ${{ github.event.pull_request.title }}
            ${{ github.event.pull_request.body }}

  post_feedback:
    if: ${{ github.actor != 'dependabot[bot]' && needs.codex.outputs.final_message != '' }}
    runs-on: ubuntu-latest
    needs: codex
    steps:
      - name: Report Codex feedback
        uses: actions/github-script@v7
        env:
          CODEX_FINAL_MESSAGE: ${{ needs.codex.outputs.final_message }}
        with:
          github-token: ${{ github.token }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: process.env.CODEX_FINAL_MESSAGE,
            });
...
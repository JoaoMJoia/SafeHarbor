---
# This workflow tests Terraform module compatibility across multiple Terraform versions.
# It ensures the module works correctly with different Terraform versions to maintain backward compatibility.
#
# How it works:
# 1. Triggers on pull requests when Terraform files (**.tf) or this workflow file changes
# 2. Can also be manually triggered via workflow_dispatch with custom parameters
# 3. Runs a matrix strategy testing against multiple Terraform versions (default: 1.9.7, 1.10.0, 1.12.1)
# 4. For each version:
#    - Authenticates with AWS using OIDC
#    - Sets up the specified Terraform version
#    - Initializes Terraform in the example folder
#    - Validates Terraform configuration
#    - Checks module syntax and formatting
#    - Verifies provider compatibility
# 5. All versions must pass for the workflow to succeed
#
# Usage:
#   - Automatically runs on PRs that modify Terraform files
#   - Manual trigger: Go to Actions > "CI - Terraform compatibilities check" > Run workflow
#   - Parameters:
#     - example-folder: Path to the example folder (default: 'example/')
#     - terraform-versions: JSON array of versions to test (default: '["1.9.7", "1.10.0", "1.12.1"]')
name: 'CI - Terraform compatibilities check'

on:
  pull_request:
    paths:
      - '**.tf'
      - '.github/workflows/ci-terraform-compatibilities.yml'
  workflow_dispatch:
    inputs:
      example-folder:
        description: 'Path to the example folder'
        type: string
        required: false
        default: 'example/'
      terraform-versions:
        description: 'List of Terraform versions to test'
        type: string
        required: false
        default: '["1.9.7", "1.10.0", "1.12.1"]'

permissions:
  id-token: write
  contents: write
  pull-requests: write

env:
  ENV_FOLDER: ${{ github.event.inputs.example-folder || 'example/' }}
  AWS_REGION: ${{ vars.AWS_REGION }}
  ROLE-TO-ASSUME: arn:aws:iam::${{ secrets.AWS_ORG_ACCOUNT }}:role/github-actions-role

jobs:
  version-compatibility:
    name: 'Version Compatibility'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        terraform_version: ${{ fromJSON(github.event.inputs.terraform-versions || '["1.9.7", "1.10.0", "1.12.1"]') }}
    defaults:
      run:
        shell: bash
        working-directory: ${{ env.ENV_FOLDER }}
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4
      - name: Login to AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE-TO-ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ matrix.terraform_version }}
      - name: Terraform Init
        run: terraform init -upgrade -no-color
      - name: Terraform Validate
        run: terraform validate -no-color
      - name: Check Module Syntax
        run: |
          terraform fmt -check -recursive
          terraform validate -json | jq -r '.diagnostics[] | select(.severity=="error")'
      - name: Verify Provider Compatibility
        run: |
          terraform providers schema -json | jq -r '.provider_schemas | keys[]'
...